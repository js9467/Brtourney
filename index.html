<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tournament Feed Manager</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    h1, h2, h3 { margin-top: 30px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 6px; margin-bottom: 10px; }
    button { padding: 10px 15px; margin-top: 10px; }
    .tournament-block { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    #fallbackLink { display: inline-block; margin-top: 10px; color: blue; text-decoration: underline; }
    .version { font-size: 0.8em; color: gray; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Tournament Feed Manager</h1>
  <div id="tournamentList"></div>

  <h2>Add New Tournament</h2>
  <form id="newTournamentForm">
    <label>Tournament Name</label>
    <input name="name" required />
    <label>Participants URL</label>
    <input name="participants" required />
    <label>Events URL</label>
    <input name="events" required />
    <button type="submit">Add Tournament</button>
  </form>

  <p>
    Having trouble submitting? <a id="fallbackLink" href="#" target="_blank">Open Issue Manually</a>
  </p>

  <p class="version">UI Version: 1.0.5</p>

  <script>
    let currentData = {};

    async function loadSettings() {
      try {
        const res = await fetch('settings.json');
        currentData = await res.json();
        const container = document.getElementById("tournamentList");
        container.innerHTML = "<h2>Edit Existing Tournaments</h2>";

        Object.entries(currentData).forEach(([name, urls]) => {
          const safeName = encodeURIComponent(name);
          const blockId = `block_${safeName}`;

          container.innerHTML += `
            <div class="tournament-block" id="${blockId}">
              <h3>${name}</h3>
              <label>Participants URL</label>
              <input name="participants_${safeName}" value="${urls.participants}" />
              <label>Events URL</label>
              <input name="events_${safeName}" value="${urls.events}" />
              <button type="button" onclick="updateSingleTournament('${name}', '${safeName}')">Update</button>
            </div>
          `;
        });
      } catch (err) {
        alert("‚ùå Failed to load settings.json. Make sure it exists and is valid.");
        console.error(err);
      }
    }

    function updateSingleTournament(name, safeName) {
      const participantsInput = document.querySelector(`input[name="participants_${safeName}"]`);
      const eventsInput = document.querySelector(`input[name="events_${safeName}"]`);

      if (!participantsInput || !eventsInput) {
        alert(`‚ùå Could not find input fields for ${name}`);
        return;
      }

      const participants = participantsInput.value.trim();
      const events = eventsInput.value.trim();

      const update = {
        [name]: {
          participants,
          events
        }
      };

      submitIssue(update);
    }

    document.getElementById("newTournamentForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value.trim();
      const participants = form.participants.value.trim();
      const events = form.events.value.trim();
      if (!name || !participants || !events) return;

      const update = {
        [name]: { participants, events }
      };

      submitIssue(update);
    });

    function submitIssue(updateData) {
      try {
        const body = JSON.stringify(updateData, null, 2);
        const title = `Tournament: Update ${new Date().toISOString()}`;
        const url = `https://github.com/js9467/Brtourney/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;

        document.getElementById("fallbackLink").href = url;

        const win = window.open(url, "_blank");
        if (!win || win.closed || typeof win.closed === "undefined") {
          alert("‚ö†Ô∏è Popup blocked. Use the fallback link below.");
        }

        console.log("üìé Issue URL:", url);
      } catch (err) {
        alert("‚ùå Failed to generate issue link.");
        console.error(err);
      }
    }

    loadSettings();
  </script>
</body>
</html>